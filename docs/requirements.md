# 要件定義書: ポケモンユナイト ソロ大会運営アプリ

## 1. プロジェクト概要

### プロジェクト名
**Jiro-Rimi Cup**

### 背景と目的
ポケモンユナイトにおいて、ハイレベルかつ継続的に開催されるソロ大会はほぼ存在しない。特に女子大会はチーム編成のハードルが高く、実力があっても露出機会が少ない。

本アプリは、ソロ参加形式の大会を円滑に運営するためのWebアプリケーションである。エントリー管理・スイスドロー式チーム分け・試合進行・成績管理を一元的に提供し、年間を通じた継続的な大会開催を支える基盤となることを目指す。

### 大会の種類
- **ボーイズ じろカップ**: 男子ソロ大会
- **ガールズ りみカップ**: 女子ソロ大会
- 同日開催（昼: ボーイズ / 夜: ガールズ）、同フォーマット
- 各大会は独立しており、大会ごとにルールが変わる可能性がある

### 利用者規模
- 同時接続: 〜50人程度（小規模）

### 開発スコープ
- MVP + 少し余裕を持たせた設計

---

## 2. 大会構造

```
大会（例: じろカップ 第1回）
├── 予選1（例: 6/1）
├── 予選2（例: 6/8）
├── 予選3（例: 6/15）
├── ...（予選回数は大会ごとに設定可能）
└── グランドファイナル（例: 6/22）
```

- 大会は「予選X回 + グランドファイナル」で構成される
- 予選の回数・日程は運営者が自由に設定
- ランキングは大会単位（予選を通じた成績で算出）
- 各大会は完全に独立したデータ空間を持つ
- 年間を通じて複数回開催される

---

## 3. ユーザー種別と権限

| ユーザー種別 | 説明 |
|---|---|
| 未ログインユーザー | 大会情報・エントリー一覧・成績の閲覧のみ |
| 参加者 | X認証でログイン。エントリー・チェックイン・勝敗入力が可能 |
| 運営者 | 大会作成・管理・試合進行の操作が可能。2〜5名を想定 |

---

## 4. 機能要件

### REQ-001: ユーザー認証
**概要**: Discord認証によるログイン

```
As a 参加者
I want Discordアカウントでログインしたい
So that 簡単に登録でき、大会中の連絡にも使えるDiscord IDが自動で紐づく
```

**受け入れ条件**:
- Supabase Auth + Discordプロバイダーでログイン
- Discord IDはログイン時に自動取得される
- 優先度: **P0**

---

### REQ-002: マイページ（プロフィール設定）
**概要**: 参加者が自身のプロフィール情報を管理する

```
As a 参加者
I want プロフィールを設定・変更したい
So that 大会参加に必要な情報を登録できる
```

**設定項目**:
- ゲーム内プレイヤー名（変更可能。ゲーム内の名前に合わせるため）
- X ID（必須。荒らし抑止力として活用）
- 性別（ボーイズ / ガールズの自己申告。大会区分に使用）
- ロール優先順位（後述）
- Discord ID（認証から自動取得。編集不可）

**ロール設定**:
- ロールは以下の5種類:
  - 上キャリー
  - 下キャリー
  - 中央
  - タンク
  - サポート
- 5つから**3つを選び、優先順位をつけて設定**（必須）
- ロールはマイページからいつでも変更可能（大会ごとに変えたい人は都度変更する）

**過去大会の成績履歴**:
- マイページから自分が参加した過去大会の成績を閲覧可能

**受け入れ条件**:
- 初回ログイン後、プロフィール設定が未完了の場合は設定画面に誘導
- すべての必須項目が入力されるまで大会エントリーは不可
- 優先度: **P0**

---

### REQ-003: 大会作成・管理（運営者向け）
**概要**: 運営者が大会を作成し、情報を管理する

```
As a 運営者
I want 大会を作成し、日程やルールを設定したい
So that 各大会を独立して管理できる
```

**大会作成時の設定項目**:
- 大会名
- 性別区分（ボーイズ / ガールズ）
- 予選の回数と各予選の日程
- グランドファイナルの日程
- 各予選のエントリー期限
- 各予選・GFのチェックイン可能時間帯（開始〜締切）
- 1予選あたりの試合数（男子: 5試合 / 女子: 4試合 など）
- GF進出人数（デフォルト: 上位20名）
- 参加上限人数（任意）

**受け入れ条件**:
- 大会情報は作成後も運営者が修正可能
- 運営者は2〜5名に権限を付与可能
- 優先度: **P0**

---

### REQ-004: 大会エントリー
**概要**: 参加者が大会の予選にエントリーする

```
As a 参加者
I want 大会の予選にエントリーしたい
So that 大会に参加できる
```

**受け入れ条件**:
- エントリーは予選単位（予選1、予選2、予選3...それぞれに個別エントリー）
- 部分参加OK（例: 予選1と予選3だけエントリーも可能）
- 性別に合った大会にのみエントリー可能（プロフィールの性別で判定）
- エントリー期限は運営者が大会登録時に設定
- エントリー後のキャンセルは可能
- プロフィール設定（ロール含む）が完了していないとエントリー不可
- グランドファイナルにはエントリーは不要（予選ランキング上位が自動進出）
- 優先度: **P0**

---

### REQ-005: エントリー一覧（公開）
**概要**: 大会のエントリー状況を誰でも閲覧できる

```
As a ユーザー（未ログイン含む）
I want 大会のエントリー状況を確認したい
So that 誰が参加するのか、ロール分布はどうかを把握できる
```

**受け入れ条件**:
- 未ログインユーザー含め誰でも閲覧可能
- エントリー者の一覧（プレイヤー名、ロール等）を表示
- エントリー人数、ロール分布の確認が可能（同一画面内）
- 予選ごとにエントリー状況を確認できる
- 優先度: **P0**

---

### REQ-006: チェックイン
**概要**: 大会当日に参加者が出席を確認する

```
As a 参加者
I want 大会当日にチェックインしたい
So that 参加意思を確定し、ドタキャンを防止できる
```

**チェックイン取り消し**:
- 参加者自身によるチェックイン取り消しは不可（出られない場合は運営者に連絡）
- 運営者はチェックインの追加・削除が可能（遅刻者の救済、ドタキャンした人の除外等）

**チェックイン状況の公開**:
- チェックイン済みの人数・一覧は未ログインユーザー含め全体公開

**受け入れ条件**:
- 予選・グランドファイナルともにチェックインが必要
- チェックイン可能時間帯は運営者が大会登録時に設定
- チェックインしなかった場合、その日の参加権利を失う
- 優先度: **P0**

---

### REQ-007: 予選 - チーム分け（スイスドロー形式）
**概要**: 運営者が手動でチームを編成し、AIアシスト機能で補助する

```
As a 運営者
I want チーム分けを手動で行い、必要に応じてAIの提案を活用したい
So that ロールバランスの取れた公平なチーム編成ができる
```

**チーム編成の方式**:
- 運営者による手動編成がベース
- チーム編成画面にチェックイン済み参加者の一覧が表示される
- 運営者が手動でチームにメンバーを配置する
- 「AIアシスト」ボタンを押すと、AIがロール・成績を考慮したチーム案を自動生成する
- 運営者がAI案を確認し、必要に応じて手動で微調整して確定する

**チーム編成のタイミング**:
- 毎試合ごとにチーム編成画面が表示される
- 前回のチーム構成がデフォルト（初期値）として設定される
- 変更が必要な場合は手動調整またはAIアシストを使用する

**マッチの組み合わせ**:
- スイスドロー方式: 勝敗数が近い人同士が同じマッチに集まるようにする
- 第1試合（全員0勝0敗）はランダムにマッチを組む
- チーム分けの詳細アルゴリズム: **実装時検討**（AIアシストのプロンプトで調整）
- マッチの組み合わせロジック: **実装時検討**

**奇数人数の場合の扱い**: **TBD（主催者確認事項）**

**受け入れ条件**:
- 運営者がチーム編成画面でメンバーを配置できる
- AIアシストボタンでチーム案を自動生成できる
- 毎試合ごとに編成画面が表示され、前回構成がデフォルト
- 優先度: **P0**

---

### REQ-008: 予選 - 試合進行
**概要**: 運営者が試合を開始し、参加者が対戦情報を確認・勝敗を入力する

```
As a 運営者
I want 試合の開始・進行を管理したい
So that 大会をスムーズに進行できる
```

```
As a 参加者
I want 対戦相手とロビー番号を確認し、勝敗を入力したい
So that 試合に参加し、結果を記録できる
```

**予選1回分の進行フロー**:
```
1. チェックイン締切 → 当日の参加者が確定
2. 運営者がチーム編成画面でチームを構成（手動 or AIアシスト）（REQ-007）
3. 運営者がDiscordで通知 → 「試合開始」ボタンを押す（全マッチ一斉開始）
4. 参加者の画面に以下が表示される:
   - 対戦相手チームの情報
   - ロビー番号入力欄
   - 勝敗入力フォーム（試合開始時点から表示）
5. ロビー番号を入力（後述）
6. ゲーム内で試合を実施
7. 試合終了後、各参加者が自分の勝敗を入力（個人単位）
8. 多数決で仮結果が自動算出される
9. 全マッチの仮結果が出揃ったら、運営者が結果を確認し「結果確定」ボタンを押す
10. 運営者がチーム編成画面で次の試合のチームを構成（前回構成がデフォルト）
11. 3〜10を繰り返し、規定試合数（男子5 / 女子4 など）を消化して予選終了
```

**ロビー番号**:
- 1マッチの10人全員および運営者にロビー番号入力フォームが表示される
- 後勝ち方式: 誰でも入力可能で、後から入力した値で上書きされる
- 間違いがあれば別の人が修正できる運用

**勝敗入力**:
- 試合はゲーム内で行われ、アプリからは試合状況を確認できない
- 試合開始後、参加者の画面には即座に勝敗入力フォームが表示される
- **個人単位**: 各参加者が自分の勝ち/負けを入力する
- **多数決で自動確定**: 同マッチ内の入力から多数決で仮結果を算出。明らかな不一致（5:5等）は運営者に通知
- **運営者承認**: 全マッチの仮結果が出揃った後、運営者が確認し「結果確定」ボタンで確定する
- 運営者は全マッチの勝敗入力状況を確認でき、運営者側で勝敗の入力・変更が可能

**ステータス管理**:
- 予選のステータス: `チェックイン受付中` → `参加者確定` → `試合進行中` → `予選終了`
- マッチのステータス: `待機中` → `進行中` → `確定済`
  - 待機中: チーム分け済、試合開始前
  - 進行中: 試合開始〜運営者確定前（勝敗入力はいつでも可能）
  - 確定済: 運営者が結果を確定

**試合中の回線落ち等の対応**:
- アプリ上では特に機能を設けない。運営者がDiscord等で個別対応する

**参加者の途中離脱時の扱い**: **TBD（主催者確認事項）**

**受け入れ条件**:
- 運営者が「試合開始」操作を行うまで対戦情報は非表示
- 全マッチ一斉に試合を開始する
- 全マッチの仮結果が出揃い、運営者が確定するまで次の試合に進めない
- 優先度: **P0**

---

### REQ-008-A: 運営者 - 試合進行管理画面
**概要**: 運営者が予選の進行状況を管理するための画面

```
As a 運営者
I want 全マッチの進行状況を一覧で把握し、勝敗を管理したい
So that 大会を円滑に進行できる
```

**表示・操作項目**:
- チーム編成画面（手動配置 + AIアシストボタン、前回構成がデフォルト）
- 全マッチ一覧（各マッチのチーム構成・ユーザー名）
- 各ユーザーの現在の成績（勝敗数）
- 各ユーザーの勝敗入力状況（入力済み / 未入力）
- 多数決による仮結果の表示、不一致マッチのハイライト
- 勝敗入力フォーム（運営者が直接入力・変更可能）
- 試合開始ボタン / 結果確定ボタン

**受け入れ条件**:
- リアルタイムで入力状況が更新される
- 優先度: **P0**

---

### REQ-009: 成績・ランキング（公開）
**概要**: 大会の成績とランキングを表示する

```
As a ユーザー（未ログイン含む）
I want 大会の成績やランキングを確認したい
So that 大会の進行状況や結果を把握できる
```

**受け入れ条件**:
- 未ログインユーザー含め誰でも閲覧可能
- 大会単位のランキング（予選を通じた総合成績）
- 各予選ごとの詳細成績
- ランキングはリアルタイム更新（各試合の結果確定ごとに反映）
- 参加日数が異なる場合のランキング評価方法: **TBD（主催者確認事項）**
- 優先度: **P0**

---

### REQ-010: グランドファイナル
**概要**: 予選上位者によるグランドファイナルの進行

```
As a 運営者
I want グランドファイナルを運営したい
So that 大会のクライマックスを演出できる
```

**GF進出**:
- 予選ランキング上位20名（デフォルト、大会設定で変更可能）が自動進出
- エントリーは不要
- チェックインは必要（チェックインしなければ参加権利喪失）
- チェックイン欠席時の繰り上げ進出はなし
- チェックイン欠席で20名未満の場合の対応: **TBD（主催者確認事項）**

**チーム編成**:
- 運営者がアプリ上のUI（予選と同様のチーム編成画面）で手動編成
- 20名 → 4チーム × 5人
- GF中のチーム再編成はなし（チーム固定）

**トーナメント形式**:
- ダブルエリミネーショントーナメント（リセットマッチあり）
- 各対戦はBo3（3本勝負）だが、アプリはマッチの最終勝敗のみを管理する
- トーナメント表の対戦組み合わせ設定: **TBD（主催者確認事項）**

**ブラケット構造（4チームの場合）**:
```
【ウィナーズブラケット】
W-R1: チームA vs チームB → 勝者W1
W-R1: チームC vs チームD → 勝者W2
W-Final: W1 vs W2 → ウィナーズ優勝

【ルーザーズブラケット】
L-R1: W-R1の敗者同士 → 勝者L1
L-Final: L1 vs W-Finalの敗者 → 勝者L2

【グランドファイナル】
GF: ウィナーズ優勝 vs L2
→ ウィナーズ側が負けた場合、リセットマッチ（もう1試合）
```
- 計5〜6試合（リセットマッチの有無で変動）

**勝敗入力方式**:
- 予選と同じ方式（個人単位 → 多数決で仮結果 → 運営者確定）

**試合進行フロー**:
- 予選と同じ仕組み（運営者が試合開始 → ロビー番号入力 → 勝敗入力）
- 運営者の管理画面も予選と同様
- トーナメントの進行に従い、次の対戦カードが自動的に決定される

**公開情報**:
- トーナメント表とチーム分け情報が閲覧可能（未ログイン含む）

**受け入れ条件**:
- 予選ランキングから自動的にGF進出者が決定される
- 勝敗入力は参加者が行い、運営者も入力・変更可能
- トーナメント表がリアルタイムで更新される
- 優先度: **P0**

---

### REQ-011: マイページ - 過去大会成績
**概要**: 参加者が自分の過去の大会成績を確認する

```
As a 参加者
I want 過去に参加した大会の成績を一覧で見たい
So that 自分の実績を振り返れる
```

**表示項目**:
- 大会名
- 参加した予選の数
- 勝敗数
- 最終順位

**受け入れ条件**:
- マイページから過去大会の成績履歴を閲覧可能
- 大会ごとの上記情報を確認できる
- 優先度: **P1**

---

## 5. 主要なデータ（概念レベル）

| データ | 説明 |
|---|---|
| ユーザー | Discord ID、プレイヤー名、X ID、性別、ロール優先順位 |
| 大会 | 大会名、性別区分、ルール設定、GF進出人数 |
| 予選 | 大会に紐づく各予選回の情報、日程、エントリー期限、チェックイン時間帯 |
| エントリー | どのユーザーがどの予選にエントリーしたか |
| チェックイン | どのユーザーがどの予選/GFにチェックインしたか |
| マッチ | 各試合のチーム編成（5人 × 2チーム）、ロビー番号 |
| 勝敗結果 | 各マッチの勝敗と個人の勝敗記録 |
| ランキング | 大会単位の総合成績・順位 |

---

## 6. 外部連携

| サービス | 用途 |
|---|---|
| Supabase Auth | Discord認証 |
| Supabase Database (PostgreSQL) | データベース（リレーショナルデータ、リアルタイム更新） |
| Vercel | Webアプリホスティング、サーバーサイド処理 (Next.js) |
| Supabase Edge Functions | 定期実行やWebhookなど、Next.js外での処理が必要な場合 |

---

## 7. TBD一覧

### 解決済み

| # | 項目 | 関連要件 | 決定内容 |
|---|---|---|---|
| 2 | チェックイン後のドタキャン対応 | REQ-006 | 参加者自身の取り消し不可。運営者に連絡し、運営者がチェックイン追加・削除を行う |
| 4 | チーム分け結果の手動調整可否 | REQ-007 | 手動編成がベース。AIアシストボタンで自動提案を生成し、運営者が微調整して確定 |
| 5 | チーム分けの詳細アルゴリズム | REQ-007 | 実装時検討（AIアシストのプロンプトで調整） |
| 6 | マッチの組み合わせロジック | REQ-007 | 実装時検討 |
| 7 | 勝敗入力の単位 | REQ-008 | 個人単位。各参加者が自分の勝ち/負けを入力。多数決で仮結果を自動算出し、運営者が確定 |
| 8 | 試合のステータス管理 | REQ-008 | 2層構成。予選: チェックイン受付中→参加者確定→試合進行中→予選終了 / マッチ: 待機中→進行中→確定済 |
| 9 | 試合中の回線落ち等の対応 | REQ-008 | アプリ上では対応せず、運営者がDiscord等で個別対応 |
| 11 | GFチーム編成の入力方法 | REQ-010 | アプリ上のUI（予選と同様のチーム編成画面）で手動編成 |

### 未解決（主催者確認事項）

| # | 項目 | 関連要件 | 備考 |
|---|---|---|---|
| 1 | 参加日数が異なる場合のランキング評価方法 | REQ-009 | 総勝利数 or 勝率 等、主催者と要相談 |
| 3 | 奇数人数の場合のチーム分け | REQ-007 | 不戦勝 / BYE / 運営調整 等 |
| 10 | 参加者の途中離脱時の扱い | REQ-008 | 残り試合のチーム編成への影響 |

### 未解決（GF関連 — Phase 3 で検討）

| # | 項目 | 関連要件 | 備考 |
|---|---|---|---|
| 12 | GFチェックイン欠席で20名未満の場合の対応 | REQ-010 | チーム数調整 等 |
| 13 | GFトーナメント表の対戦組み合わせ設定 | REQ-010 | 運営者が手動設定 or 自動生成 |

### 未解決（その他）

| # | 項目 | 関連要件 | 備考 |
|---|---|---|---|
| 14 | 参加上限超過時の扱い | REQ-004 | 先着順 / 抽選 等 |

---

## 8. プロダクトバックログで詰める領域

以下の領域は要件定義では大枠のみ定義済み。詳細仕様はプロダクトバックログで検討する。

| 領域 | 現状 | バックログで詰める内容 |
|---|---|---|
| 成績・ランキング表示 | REQ-009で基本方針のみ | 表示項目の詳細、ソート条件、フィルタ、ランキング算出ロジック |
| 運営者の管理機能 | REQ-003, REQ-008-Aで基本方針のみ | 権限管理の詳細、運営者招待フロー、大会一覧管理画面 |
| 観戦ページ | REQ-005, REQ-009, REQ-010で公開方針のみ | ページ構成、表示内容の詳細、リアルタイム更新範囲 |
| 画面設計 | 未着手 | 各画面のワイヤーフレーム、画面遷移図 |
| 非機能要件 | 未着手 | パフォーマンス、セキュリティ、アクセシビリティ |
